# CSR圧縮と量子化によるニューラルネットワーク最適化

## 概要

Arduino Uno R4 WiFi上で動作するRGBスキャナーのためのニューラルネットワークを、CSR（Compressed Sparse Row）形式と量子化により圧縮・最適化するプロジェクトです。

**圧縮の適用範囲**: 1層目（3 → HIDDEN_DIM）と2層目（HIDDEN_DIM → HIDDEN_DIM）の両方にCSR圧縮と量子化を適用し、メモリ使用量を大幅に削減します。

## 目標

1. **CSR形式の実装**: L1正則化による疎化を活かし、1層目と2層目の両方でCSR圧縮を適用してメモリ使用量を削減
2. **量子化の適用**: CSR圧縮モデルの1層目と2層目に対して量子化を適用し、さらなる圧縮を実現
3. **次元拡張**: 隠れ層次元を40から600以上へ拡張可能にする（圧縮により高次元化が可能）
4. **MSE評価**: 「非圧縮」「CSR圧縮（1層目・2層目）」「CSR+量子化（1層目・2層目）」のMSEを比較

## ファイル構成

```
Lec.1/
├── Arduino/                          # Arduino実装コード
│   ├── AI_Before/                    # ニューラルネットワークなし（ベースライン）
│   │   └── AI_Before.ino
│   ├── AI_Model/                     # 通常の密行列形式
│   │   ├── AI_Model.ino
│   │   ├── model_parameters40.h
│   │   ├── model_parameters50.h
│   │   ├── model_parameters60.h
│   │   └── model_parameters70.h
│   ├── AI_CSR/                       # CSR形式で圧縮
│   │   ├── AI_CSR.ino
│   │   ├── model_parameters_csr40.h
│   │   ├── model_parameters_csr80.h
│   │   ├── model_parameters_csr120.h
│   │   ├── model_parameters_csr160.h
│   │   ├── model_parameters_csr200.h
│   │   ├── model_parameters_csr400.h
│   │   ├── model_parameters_csr500.h
│   │   ├── model_parameters_csr600.h
│   │   ├── model_parameters40.h
│   │   ├── model_parameters80.h
│   │   ├── model_parameters120.h
│   │   ├── model_parameters160.h
│   │   ├── model_parameters200.h
│   │   ├── model_parameters400.h
│   │   ├── model_parameters500.h
│   │   └── model_parameters600.h
│   └── AI_CSR_Quantized/            # CSR+量子化形式
│       ├── AI_CSR_Quantized.ino
│       ├── model_parameters_csr_quantized40.h
│       ├── model_parameters_csr_quantized80.h
│       ├── model_parameters_csr_quantized120.h
│       ├── model_parameters_csr_quantized160.h
│       ├── model_parameters_csr_quantized200.h
│       ├── model_parameters_csr_quantized300.h
│       ├── model_parameters_csr_quantized400.h
│       ├── model_parameters_csr_quantized500.h
│       ├── model_parameters_csr_quantized600.h
│       ├── model_parameters_csr_quantized800.h
│       ├── model_parameters_csr_quantized1000.h
│       └── 対応するmodel_parameters*.hファイル
│
├── train_L1_normalization.ipynb      # 学習とCSR/量子化パラメータ生成
├── mse_calculator.html                # MSE評価ツール（ブラウザで実行）
│
├── ppm/                              # PPM画像データ
│   ├── reference_image1.ppm          # MSE評価用の参照画像
│   ├── nn40/                          # AI_Model 40次元の実験結果
│   │   └── nn1.ppm ~ nn10.ppm
│   ├── nn50/                          # AI_Model 50次元の実験結果
│   │   └── nn50_1.ppm ~ nn50_10.ppm
│   ├── nn60/                          # AI_Model 60次元の実験結果
│   │   └── nn60_1.ppm ~ nn60_10.ppm
│   ├── csr_40_0.01/                   # CSR 40次元、閾値0.01の実験結果
│   │   └── csr1.ppm ~ csr10.ppm
│   ├── csr_80_0.01/                   # CSR 80次元、閾値0.01の実験結果
│   │   └── 1.ppm ~ 10.ppm
│   ├── csr_120_0.01/                  # CSR 120次元、閾値0.01の実験結果
│   │   └── 1.ppm ~ 10.ppm
│   ├── csr_160_0.01/                  # CSR 160次元、閾値0.01の実験結果
│   │   └── 1.ppm ~ 10.ppm
│   ├── csr_200_0.01/                  # CSR 200次元、閾値0.01の実験結果
│   │   └── 1.ppm ~ 10.ppm
│   ├── csr_400_0.01/                  # CSR 400次元、閾値0.01の実験結果
│   │   └── 1.ppm ~ 10.ppm
│   ├── csr600_0.01/                   # CSR 600次元、閾値0.01の実験結果
│   │   └── 1.ppm ~ 10.ppm
│   ├── q+csr_40_0.01/                 # CSR+量子化 40次元の実験結果
│   │   └── 1.ppm ~ 10.ppm (q1.ppm ~ q10.ppmとして記録)
│   ├── q+csr80_0.01/                  # CSR+量子化 80次元の実験結果
│   │   └── 1.ppm ~ 10.ppm
│   └── q+csr120_0.01/                 # CSR+量子化 120次元の実験結果
│       └── 1.ppm ~ 10.ppm
│
├── img/                              # 参照画像
│   ├── reference_image1_cmyk_large.png
│   └── reference_image2_cmyk_large.png
│
├── report/                           # レポート関連
│   ├── pre/                          # プレゼン資料
│   │   └── bugg.tex, bugg.pdf
│   └── stg/                          # ステージング資料
│       └── stg.tex, stg.pdf
│
├── requirements.txt                  # Python依存関係
└── README.md                         # このファイル
```

### 主要ディレクトリの説明

#### Arduinoコード
- **`Arduino/AI_Before/`**: ニューラルネットワークなしのベースライン実装
- **`Arduino/AI_Model/`**: 通常の密行列形式のニューラルネットワーク実装（40, 50, 60, 70次元対応）
- **`Arduino/AI_CSR/`**: CSR形式で圧縮したニューラルネットワーク実装（40, 80, 120, 160, 200, 400, 500, 600次元対応）
- **`Arduino/AI_CSR_Quantized/`**: CSR+量子化形式のニューラルネットワーク実装（40, 80, 120, 160, 200, 300, 400, 500, 600, 800, 1000次元対応）

#### 学習・評価
- **`train_L1_normalization.ipynb`**: モデルの学習、1層目・2層目のCSR形式への変換、量子化パラメータの生成を行うJupyter Notebook
- **`mse_calculator.html`**: MSE評価ツール（ブラウザで実行、参照画像とスキャン結果を比較）

#### データファイル
- **`ppm/`**: 実験で使用するPPM画像ファイル
  - `nn40/`, `nn50/`, `nn60/`: 密行列形式の各次元での実験結果
  - `csr_*_0.01/`: 各次元でのCSR実験結果
  - `q+csr*_0.01/`: 各次元でのCSR+量子化実験結果
- **`img/`**: 参照画像（PNG形式）
- **`ppm/reference_image1.ppm`**: MSE評価で使用する基準画像（PPM形式）

## 実験方法

### 実験の目的

Arduino Uno R4 WiFiのメモリ制約下において、ニューラルネットワークの隠れ層次元を拡張しつつ、推論精度を維持することです。具体的には、隠れ層次元を40から600以上へ拡張可能とし、画像復元品質の向上を実現することを目指します。

### 実験条件

| 項目 | 設定値 |
|------|--------|
| 隠れ層次元 | 40, 50, 60, 70, 80, 120, 160, 200, 400, 600 |
| プルーニング閾値 | 0.01（固定） |
| 正則化 | L1正則化 |
| 疎行列形式 | CSR形式 |
| 量子化 | int8（必要に応じて適用） |

### 実験手順

#### フェーズ1: 訓練・圧縮フェーズ

PC上でPyTorchを用いてニューラルネットワークを訓練し、CSR形式への変換および量子化を適用してパラメータファイルを生成します。

**ステップ1: データ準備**
- `train_L1_normalization.ipynb`を開く
- 必要なライブラリ（PyTorch, NumPy, SciPy等）をインポート
- PPM形式のカラーチャート画像を読み込み、推論用データを準備

**ステップ2: ニューラルネットワークの学習**
- L1正則化を適用したニューラルネットワークを学習
- `HIDDEN_DIM`を設定（例: 40, 80, 120）
- 学習完了後、`model_parameters.h`が自動生成される（密行列形式）

**ステップ3: CSR形式への変換**
- 学習済みモデルに対し、プルーニング閾値0.01でプルーニングを実施
- 重み行列をCSR形式に変換（1層目と2層目の両方）
- 変換後のパラメータは`model_parameters_csr.h`として出力
- 各次元に対してこの処理を行い、ファイルをリネームして管理
  - 例: `model_parameters_csr40.h`, `model_parameters_csr80.h`

**ステップ4: 量子化の適用（オプション）**
- CSR形式のパラメータに対してint8量子化を追加適用
- float32形式の重みをint8形式に変換し、スケールを算出
- 量子化後のパラメータは`model_parameters_csr_quantized.h`として出力

#### フェーズ2: デプロイフェーズ

生成したパラメータファイルをArduino Uno R4 WiFiに組み込み、実機へ書き込みます。

**ステップ1: パラメータファイルの配置**
- 生成されたパラメータファイルを対応するArduinoプロジェクトフォルダにコピー
  - `model_parameters.h` → `Arduino/AI_Model/`
  - `model_parameters_csr*.h` → `Arduino/AI_CSR/`
  - `model_parameters_csr_quantized*.h` → `Arduino/AI_CSR_Quantized/`

**ステップ2: Arduinoコードの設定**
- 各Arduinoプロジェクト内の`.ino`ファイルを開き、以下を設定：
  - `HIDDEN_DIM`マクロを学習時と同一の値に設定
  - 対応するパラメータファイルをインクルード

**ステップ3: コンパイルとアップロード**
- Arduino IDEで対象の`.ino`ファイルを開く
- ボード設定を「Arduino UNO R4 WiFi」に設定
- 接続されているシリアルポートを選択
- 「検証」ボタンでコンパイルエラーがないことを確認
- 「アップロード」ボタンでArduinoに書き込む
- コンパイル時にはメモリ使用量が表示される（SRAM使用量が32KBを超える場合はアップロードに失敗）

#### フェーズ3: 評価フェーズ

センサーデータを用いて推論を実行し、出力画像と参照画像のMSEを計算して品質を評価します。

**ステップ1: キャリブレーション**
- 赤色タクトスイッチ（D2ピン）を押し、キャリブレーションモードに入る
- 黒色サンプルをセンサにかざし、青色タクトスイッチ（D3ピン）を押して最小値を記録
- 白色サンプルをセンサにかざし、青色タクトスイッチを押して最大値を記録
- 赤色タクトスイッチを押し、キャリブレーションモードを終了

**ステップ2: カラーチャートの読み取り**
- 3×3のカラーチャートをセンサで読み取る
- 各セルにセンサを順番にかざし、青色タクトスイッチ（D3ピン）を押してRGB値を取得
- 取得したRGB値はニューラルネットワークによる推論を経て補正される
- 全9セルの読み取りが完了するまで繰り返す

**ステップ3: PPM画像の出力**
- 取得したRGBデータは、シリアル通信を介してPCに送信され、PPM形式の画像ファイルとして出力
- 出力されたPPMファイルは、実験条件ごとに適切なフォルダに保存

**ステップ4: MSE評価**
- `mse_calculator.html`をブラウザで開く
- 参照画像（`ppm/reference_image1.ppm`）をドラッグ&ドロップ
- スキャン結果のPPMファイルをドラッグ&ドロップ
- 算出されたMSE値を記録
- 各実験条件のすべてのスキャン結果についてMSEを算出し、平均値・最小値・最大値を求める

### 評価方法

推論精度の評価指標として、平均二乗誤差（MSE: Mean Squared Error）を用います。

MSEは以下の式で定義されます：

```
MSE = (1/N) × Σ(y_i - ŷ_i)²
```

ここで、Nは画素数、y_iは参照画像の画素値、ŷ_iはスキャン結果の画素値です。

本実験ではRGB画像を扱うため、各ピクセルについてR、G、Bチャネルごとの差の2乗を加算し、チャネル数で除した値をMSEとして算出します。

### 比較対象

本実験では、以下の3種類のモデルを比較対象としました：

1. **密行列形式（非圧縮）**: L1正則化のみを適用し、圧縮処理を行わないベースラインモデル
2. **CSR圧縮**: プルーニング後にCSR形式へ変換したモデル
3. **CSR＋量子化**: CSR圧縮に加えてint8量子化を適用したモデル

## 実験結果

### 結果サマリー

| 圧縮手法 | 隠れ層次元 | MSE最小値 | MSE最大値 | MSE平均値 | メモリ使用量 | コンパイル時間 |
|---------|-----------|----------|----------|----------|------------|--------------|
| **密行列形式** | 40 | 277.67 | 792.85 | 595.95 | 14524バイト（44%） | 4.303s |
| **密行列形式** | 50 | 231.11 | 535.59 | 406.93 | 18444バイト（56%） | 4.589s |
| **密行列形式** | 60 | 138.00 | 423.22 | 305.48 | 23164バイト（70%） | 4.831s |
| **密行列形式** | 70 | - | - | - | コンパイルエラー | - |
| **CSR圧縮** | 40 | 324.00 | 692.37 | 518.58 | 8488バイト（25%） | 3.783s |
| **CSR圧縮** | 80 | 225.19 | 729.26 | 464.86 | 9508バイト（29%） | 4.037s |
| **CSR圧縮** | 120 | 295.37 | 814.33 | 620.49 | 10520バイト（32%） | 4.062s |
| **CSR圧縮** | 160 | 295.52 | 1179.59 | 589.08 | 11332バイト（34%） | 4.042s |
| **CSR圧縮** | 200 | 291.41 | 979.85 | 493.35 | 12332バイト（37%） | 4.027s |
| **CSR圧縮** | 400 | 390.89 | 1978.81 | 864.40 | 17204バイト（52%） | 4.316s |
| **CSR圧縮** | 600 | 253.44 | 2143.81 | 670.69 | 21976バイト（67%） | 4.802s |
| **CSR圧縮** | 800 | - | - | - | コンパイルエラー | - |
| **CSR＋量子化** | 40 | 278.78 | 588.15 | 408.97 | 8160バイト（24%） | 3.772s |
| **CSR＋量子化** | 80 | 200.22 | 323.96 | 270.68 | 9148バイト（27%） | 3.809s |
| **CSR＋量子化** | 120 | 169.37 | 310.63 | 244.83 | 10132バイト（30%） | 4.028s |
| **CSR＋量子化** | 160 | - | - | - | 12000バイト（36%） | 4.033s |
| **CSR＋量子化** | 200 | - | - | - | 12000バイト（36%） | 4.033s |
| **CSR＋量子化** | 400 | - | - | - | 16836バイト（51%） | 4.307s |
| **CSR＋量子化** | 600 | - | - | - | 21684バイト（66%） | 4.801s |
| **CSR＋量子化** | 800 | - | - | - | コンパイルエラー | - |

### 隠れ層次元別MSE比較（平均値）

| 隠れ層次元 | 非圧縮 | CSR圧縮 | CSR＋量子化 |
|-----------|--------|---------|------------|
| 40 | 595.95 | 518.58 | 408.97 |
| 50 | 406.93 | - | - |
| 60 | 305.48 | - | - |
| 70 | コンパイルエラー | - | - |
| 80 | コンパイルエラー | 464.86 | 270.68 |
| 120 | コンパイルエラー | 620.49 | 244.83 |
| 160 | コンパイルエラー | 589.08 | - |
| 200 | コンパイルエラー | 493.35 | - |
| 400 | コンパイルエラー | 864.40 | - |
| 600 | コンパイルエラー | 670.69 | - |
| 800 | コンパイルエラー | コンパイルエラー | コンパイルエラー |

### 詳細結果

#### AI_Model（密行列形式、40次元）

| ファイル | MSE | ファイル | MSE |
|---------|-----|---------|-----|
| nn1.ppm | 484.04 | nn6.ppm | 715.63 |
| nn2.ppm | 713.74 | nn7.ppm | 523.63 |
| nn3.ppm | 733.93 | nn8.ppm | 792.85 |
| nn4.ppm | 277.67 | nn9.ppm | 284.15 |
| nn5.ppm | 782.33 | nn10.ppm | 651.52 |

- **最小値**: 277.67
- **最大値**: 792.85
- **平均値**: 595.95
- **メモリ使用量**: 14524バイト（44%）
- **コンパイル時間**: 4.303s

#### AI_Model（密行列形式、50次元）

| ファイル | MSE | ファイル | MSE |
|---------|-----|---------|-----|
| nn50_1.ppm | 369.30 | nn50_6.ppm | 231.11 |
| nn50_2.ppm | 486.26 | nn50_7.ppm | 463.85 |
| nn50_3.ppm | 444.11 | nn50_8.ppm | 307.26 |
| nn50_4.ppm | 472.78 | nn50_9.ppm | 342.67 |
| nn50_5.ppm | 416.04 | nn50_10.ppm | 535.59 |

- **最小値**: 231.11
- **最大値**: 535.59
- **平均値**: 406.93
- **メモリ使用量**: 18444バイト（56%）
- **コンパイル時間**: 4.589s

#### AI_Model（密行列形式、60次元）

| ファイル | MSE | ファイル | MSE |
|---------|-----|---------|-----|
| nn60_1.ppm | 193.07 | nn60_6.ppm | 332.41 |
| nn60_2.ppm | 138.00 | nn60_7.ppm | 297.22 |
| nn60_3.ppm | 376.22 | nn60_8.ppm | 417.44 |
| nn60_4.ppm | 227.26 | nn60_9.ppm | 240.33 |
| nn60_5.ppm | 423.22 | nn60.ppm | 409.30 |

- **最小値**: 138.00
- **最大値**: 423.22
- **平均値**: 305.48
- **メモリ使用量**: 23164バイト（70%）
- **コンパイル時間**: 4.831s

#### AI_Model（密行列形式、70次元）

コンパイルエラー（メモリ不足）

#### CSR_model（40次元、プルーニング閾値0.01）

| ファイル | MSE | ファイル | MSE |
|---------|-----|---------|-----|
| csr1.ppm | 600.00 | csr6.ppm | 365.07 |
| csr2.ppm | 517.48 | csr7.ppm | 522.59 |
| csr3.ppm | 569.78 | csr8.ppm | 495.04 |
| csr4.ppm | 659.04 | csr9.ppm | 692.37 |
| csr5.ppm | 324.00 | csr10.ppm | 440.41 |

- **最小値**: 324.00
- **最大値**: 692.37
- **平均値**: 518.58
- **メモリ使用量**: 8488バイト（25%）
- **コンパイル時間**: 3.783s

#### CSR_model（80次元、プルーニング閾値0.01）

| ファイル | MSE | ファイル | MSE |
|---------|-----|---------|-----|
| 1.ppm | 644.59 | 6.ppm | 408.15 |
| 2.ppm | 459.37 | 7.ppm | 380.59 |
| 3.ppm | 361.33 | 8.ppm | 499.85 |
| 4.ppm | 225.19 | 9.ppm | 437.44 |
| 5.ppm | 729.26 | 10.ppm | 472.85 |

- **最小値**: 225.19
- **最大値**: 729.26
- **平均値**: 464.86
- **メモリ使用量**: 9508バイト（29%）
- **コンパイル時間**: 4.037s

#### CSR_model（120次元、プルーニング閾値0.01）

| ファイル | MSE | ファイル | MSE |
|---------|-----|---------|-----|
| 1.ppm | 724.67 | 6.ppm | 710.96 |
| 2.ppm | 295.37 | 7.ppm | 656.44 |
| 3.ppm | 663.78 | 8.ppm | 584.59 |
| 4.ppm | 514.59 | 9.ppm | 814.33 |
| 5.ppm | 694.22 | 10.ppm | 545.93 |

- **最小値**: 295.37
- **最大値**: 814.33
- **平均値**: 620.49
- **メモリ使用量**: 10520バイト（32%）
- **コンパイル時間**: 4.062s

#### CSR_model（160次元、プルーニング閾値0.01）

| ファイル | MSE | ファイル | MSE |
|---------|-----|---------|-----|
| 1.ppm | 394.30 | 6.ppm | 353.07 |
| 2.ppm | 516.96 | 7.ppm | 686.56 |
| 3.ppm | 663.78 | 8.ppm | 295.52 |
| 4.ppm | 668.63 | 9.ppm | 434.04 |
| 5.ppm | 1179.59 | 10.ppm | 698.33 |

- **最小値**: 295.52
- **最大値**: 1179.59
- **平均値**: 589.08
- **メモリ使用量**: 11332バイト（34%）
- **コンパイル時間**: 4.042s

#### CSR_model（200次元、プルーニング閾値0.01）

| ファイル | MSE | ファイル | MSE |
|---------|-----|---------|-----|
| 1.ppm | 563.52 | 6.ppm | 714.96 |
| 2.ppm | 291.41 | 7.ppm | 678.93 |
| 3.ppm | 235.52 | 8.ppm | 462.56 |
| 4.ppm | 675.11 | 9.ppm | 979.85 |
| 5.ppm | 662.07 | 10.ppm | 331.59 |

- **最小値**: 291.41
- **最大値**: 979.85
- **平均値**: 493.35
- **メモリ使用量**: 12332バイト（37%）
- **コンパイル時間**: 4.027s

#### CSR_model（400次元、プルーニング閾値0.01）

| ファイル | MSE | ファイル | MSE |
|---------|-----|---------|-----|
| 1.ppm | 390.89 | 6.ppm | 1127.33 |
| 2.ppm | 736.11 | 7.ppm | 421.78 |
| 3.ppm | 701.15 | 8.ppm | 1913.30 |
| 4.ppm | 324.52 | 9.ppm | 1978.81 |
| 5.ppm | 616.00 | 10.ppm | 434.30 |

- **最小値**: 390.89
- **最大値**: 1978.81
- **平均値**: 864.40
- **メモリ使用量**: 17204バイト（52%）
- **コンパイル時間**: 4.316s

#### CSR_model（600次元、プルーニング閾値0.01）

| ファイル | MSE | ファイル | MSE |
|---------|-----|---------|-----|
| 1.ppm | 740.33 | 6.ppm | 258.63 |
| 2.ppm | 1427.52 | 7.ppm | 292.15 |
| 3.ppm | 2143.81 | 8.ppm | 384.85 |
| 4.ppm | 285.26 | 9.ppm | 326.15 |
| 5.ppm | 253.44 | 10.ppm | 594.78 |

- **最小値**: 253.44
- **最大値**: 2143.81
- **平均値**: 670.69
- **メモリ使用量**: 21976バイト（67%）
- **コンパイル時間**: 4.802s

#### CSR_model（800次元、プルーニング閾値0.01）

コンパイルエラー（メモリオーバーフロー）

#### AI_CSR_Quantized（40次元、プルーニング閾値0.01）

| ファイル | MSE | ファイル | MSE |
|---------|-----|---------|-----|
| q1.ppm | 289.30 | q6.ppm | 471.30 |
| q2.ppm | 304.44 | q7.ppm | 582.63 |
| q3.ppm | 381.19 | q8.ppm | 324.44 |
| q4.ppm | 588.15 | q9.ppm | 321.37 |
| q5.ppm | 278.78 | q10.ppm | 548.11 |

- **最小値**: 278.78
- **最大値**: 588.15
- **平均値**: 408.97
- **メモリ使用量**: 8160バイト（24%）
- **コンパイル時間**: 3.772s

#### AI_CSR_Quantized（80次元、プルーニング閾値0.01）

| ファイル | MSE | ファイル | MSE |
|---------|-----|---------|-----|
| q1.ppm | 235.74 | q6.ppm | 268.26 |
| q2.ppm | 237.63 | q7.ppm | 323.96 |
| q3.ppm | 200.22 | q8.ppm | 270.19 |
| q4.ppm | 292.22 | q9.ppm | 313.37 |
| q5.ppm | 282.70 | q10.ppm | 282.48 |

- **最小値**: 200.22
- **最大値**: 323.96
- **平均値**: 270.68
- **メモリ使用量**: 9148バイト（27%）
- **コンパイル時間**: 3.809s

#### AI_CSR_Quantized（120次元、プルーニング閾値0.01）

| ファイル | MSE | ファイル | MSE |
|---------|-----|---------|-----|
| q1.ppm | 297.70 | q6.ppm | 169.37 |
| q2.ppm | 180.11 | q7.ppm | 228.59 |
| q3.ppm | 239.15 | q8.ppm | 257.85 |
| q4.ppm | 310.63 | q9.ppm | 196.19 |
| q5.ppm | 309.41 | q10.ppm | 259.30 |

- **最小値**: 169.37
- **最大値**: 310.63
- **平均値**: 244.83
- **メモリ使用量**: 10132バイト（30%）
- **コンパイル時間**: 4.028s

#### AI_CSR_Quantized（160次元、プルーニング閾値0.01）

- **メモリ使用量**: 12000バイト（36%）
- **コンパイル時間**: 4.033s
- **MSE測定**: 未実施

#### AI_CSR_Quantized（200次元、プルーニング閾値0.01）

- **メモリ使用量**: 12000バイト（36%）
- **コンパイル時間**: 4.033s
- **MSE測定**: 未実施

#### AI_CSR_Quantized（400次元、プルーニング閾値0.01）

- **メモリ使用量**: 16836バイト（51%）
- **コンパイル時間**: 4.307s
- **MSE測定**: 未実施

#### AI_CSR_Quantized（600次元、プルーニング閾値0.01）

- **メモリ使用量**: 21684バイト（66%）
- **コンパイル時間**: 4.801s
- **MSE測定**: 未実施

#### AI_CSR_Quantized（800次元、プルーニング閾値0.01）

コンパイルエラー（メモリオーバーフロー）

### 結果の考察

1. **非圧縮（密行列形式）**: 40次元でMSE平均値595.95、50次元で406.93、60次元で305.48と、次元を増やすほど精度が向上したが、70次元ではメモリ不足によりコンパイルエラーが発生

2. **CSR圧縮**: 
   - 40次元でMSE平均値518.58（非圧縮40次元の595.95と比較して約13%改善）
   - 80次元でMSE平均値464.86（非圧縮40次元と比較して約22%改善）
   - 600次元まで拡張してもメモリ使用量67%で動作可能

3. **CSR＋量子化**: 
   - 40次元でMSE平均値408.97（非圧縮40次元と比較して約31%改善）
   - 80次元でMSE平均値270.68（非圧縮40次元と比較して約55%改善）
   - 120次元でMSE平均値244.83（非圧縮40次元と比較して約59%改善）
   - さらにメモリ効率が向上し、600次元でもメモリ使用量66%で動作可能

4. **メモリ効率**: CSR圧縮により、非圧縮では70次元でコンパイルエラーが発生するのに対し、CSR圧縮では600次元まで拡張可能。量子化を追加することで、さらにメモリ効率が向上

## 使用方法

### 前提条件

- Python 3.x がインストールされていること
- Jupyter Notebook が利用可能であること
- Arduino IDE がインストールされていること
- Arduino Uno R4 WiFi が接続されていること

### ステップ1: 環境セットアップ

1. **依存パッケージのインストール**
   ```bash
   pip install -r requirements.txt
   ```
   または、Notebook内のCell 1-2で自動インストールされます

### ステップ2: モデルの学習とパラメータ生成

`train_L1_normalization.ipynb`を開き、以下の順序で実行します：

#### 2.1 データ準備
- **Cell 3**: 必要なライブラリをインポート
- **Cell 4**: PPMファイルを読み込み（参照画像の準備）
- **Cell 5**: 推論用データの準備

#### 2.2 モデル学習
- **Cell 6**: ニューラルネットワークの学習
  - `HIDDEN_DIM`を設定（例: 40, 80, 120）
  - 学習を実行すると、`model_parameters.h`が生成されます
  - このファイルは`Arduino/AI_Model/`にコピーして使用します

#### 2.3 CSR形式への変換
- **Cell 7**: CSR形式パラメータの生成
  - `PRUNING_THRESHOLD = 0.01`（固定）で設定
  - **1層目と2層目の両方**をCSR形式に変換
  - 実行すると、`model_parameters_csr.h`が生成されます
  - このファイルは`Arduino/AI_CSR/`にコピーして使用します

#### 2.4 量子化（オプション）
- **Cell 8**: 量子化パラメータの生成
  - `USE_QUANTIZATION = True`に設定
  - **1層目と2層目の両方**を量子化（CSR圧縮後）
  - 実行すると、`model_parameters_csr_quantized.h`が生成されます
  - このファイルは`Arduino/AI_CSR_Quantized/`にコピーして使用します

### ステップ3: Arduinoへのデプロイ

#### 3.1 パラメータファイルの配置

生成されたパラメータファイルを対応するArduinoフォルダにコピーします：

| 生成ファイル | コピー先 | 用途 |
|------------|---------|------|
| `model_parameters.h` | `Arduino/AI_Model/` | 密行列形式モデル |
| `model_parameters_csr.h` | `Arduino/AI_CSR/` | CSR形式モデル |
| `model_parameters_csr_quantized.h` | `Arduino/AI_CSR_Quantized/` | CSR+量子化モデル |

**注意**: 複数の次元で学習した場合、ファイル名を変更して管理してください
- 例: `model_parameters_csr40.h`, `model_parameters_csr80.h`, `model_parameters_csr120.h`

#### 3.2 Arduinoコードの設定

各Arduinoフォルダ内の`.ino`ファイルを開き、以下を確認・設定します：

1. **`HIDDEN_DIM`マクロの確認**
   ```cpp
   #define HIDDEN_DIM 40  // 学習時と同じ値に設定
   ```

2. **パラメータファイルのインクルード**
   ```cpp
   #include "model_parameters_csr.h"  // 使用するファイル名に合わせる
   ```

#### 3.3 コンパイルとアップロード

1. Arduino IDEで`.ino`ファイルを開く
2. ボードを「Arduino Uno R4 WiFi」に設定
3. シリアルポートを選択
4. 「検証」でコンパイルエラーがないか確認
5. 「アップロード」でArduinoに書き込む

### ステップ4: 実験と評価

#### 4.1 スキャン実行

Arduinoにアップロード後、スキャナーを実行してPPMファイルを生成します。

#### 4.2 MSE評価

生成されたPPMファイルを`ppm/`フォルダ内の適切なサブフォルダに保存し、MSEを計算します：

- **評価ツール**: `mse_calculator.html`をブラウザで開く
- **参照画像**: `ppm/reference_image1.ppm`を使用
- **手順**:
  1. `mse_calculator.html`をブラウザで開く
  2. 参照画像（`ppm/reference_image1.ppm`）をドラッグ&ドロップ
  3. スキャンしたPPMファイルをドラッグ&ドロップ
  4. MSE値を記録

#### 4.3 結果の記録

実験結果は`ppm/`フォルダ内に整理して保存します：
- `nn40/`, `nn50/`, `nn60/`: 密行列形式の各次元の結果
- `csr_40_0.01/`, `csr_80_0.01/`, etc.: CSR形式の各次元の結果
- `q+csr_40_0.01/`, `q+csr80_0.01/`, etc.: CSR+量子化形式の各次元の結果

## 圧縮方法

### CSR圧縮
- **適用層**: 1層目（3 → HIDDEN_DIM）と2層目（HIDDEN_DIM → HIDDEN_DIM）の両方
- **手法**: L1正則化による疎化後、プルーニング閾値（0.01）でゼロ要素を削除し、CSR（Compressed Sparse Row）形式に変換
- **圧縮効果**: 非ゼロ要素のみを保存することで、メモリ使用量を大幅に削減（圧縮率はスパース性に依存、通常3-30倍）

### 量子化
- **適用層**: 1層目と2層目の両方（CSR圧縮後）
- **手法**: float32の重みをint8に量子化（8-bit量子化）
- **圧縮効果**: データ型を4バイトから1バイトに削減することで、さらに4倍のメモリ削減を実現

### 圧縮の組み合わせ
- **AI_CSR**: CSR圧縮のみ（1層目・2層目ともにCSR形式）
- **AI_CSR_Quantized**: CSR圧縮 + 量子化（1層目・2層目ともにCSR+量子化形式）

## パラメータファイル

- `model_parameters.h`: 通常の密行列形式（全層）
- `model_parameters_csr.h`: CSR形式（1層目・2層目の両方）
  - `data_1`, `indices_1`, `indptr_1`: 1層目のCSRパラメータ
  - `data_2`, `indices_2`, `indptr_2`: 2層目のCSRパラメータ
- `model_parameters_csr_quantized.h`: 量子化CSR形式（1層目・2層目の両方）
  - `data_1_quantized`, `scale_factor_1`, `indices_1`, `indptr_1`: 1層目の量子化CSRパラメータ
  - `data_2_quantized`, `scale_factor_2`, `indices_2`, `indptr_2`: 2層目の量子化CSRパラメータ

## 注意事項

- `HIDDEN_DIM`は学習時とArduinoコードで一致させること
- 次元を大きくするとメモリ使用量が増加するため、Arduinoの制約を確認
- **CSR圧縮は1層目と2層目の両方に適用**（3層目は密行列のまま）
- **量子化はCSR形式のパラメータに対して適用**（1層目・2層目の両方）
- **プルーニング閾値は0.01で固定**（Cell 7で`PRUNING_THRESHOLD = 0.01`を設定）
